<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:app="clr-namespace:_2D_RPG_Negiramen"
             xmlns:modelsDrawing="clr-namespace:_2D_RPG_Negiramen.Models.Drawing"
             xmlns:skia="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewModels="clr-namespace:_2D_RPG_Negiramen.ViewModels"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="_2D_RPG_Negiramen.Views.TileCropPage"
             x:Name="thisContentPage"
             Loaded="ContentPage_Loaded"
             NavigatedTo="thisContentPage_NavigatedTo">

    <!--    リソースの用意
            ==============
    -->
    <ContentPage.Resources>
        <!--    バリデーション
                ==============
        -->
        <Style x:Key="InvalidEntryStyle" TargetType="Entry">
            <Setter Property="TextColor" Value="Red" />
        </Style>
        <Style x:Key="ValidEntryStyle" TargetType="Entry">
            <Setter Property="TextColor" Value="Black" />
        </Style>
    </ContentPage.Resources>

    <!-- 束縛しているビューモデル -->
    <ContentPage.BindingContext>
        <viewModels:TileCropPageViewModel />
    </ContentPage.BindingContext>

    <!--    画面内タイトル
            ==============
    -->
    <Shell.TitleView>
        <Grid ColumnDefinitions="*,*"
              BackgroundColor="SkyBlue">
            <!--    パンくずリスト
                    ==============
            -->
            <HorizontalStackLayout Grid.Column="0"
                                   HorizontalOptions="Start">
                
                <!--    ［ホーム］ボタン
                        ================
                -->
                <Button Margin="16,2,2,2"
                        Text="{app:Translate Home}"
                        SemanticProperties.Hint="Back to the home"
                        Clicked="HomeBtn_Clicked">
                    <Button.GestureRecognizers>
                        <PointerGestureRecognizer PointerEntered="Button_PointerGestureRecognizer_PointerEntered"
                                                  PointerExited="Button_PointerGestureRecognizer_PointerExited"/>
                    </Button.GestureRecognizers>
                </Button>

                <Label VerticalTextAlignment="Center"
                       Text="＞"
                       SemanticProperties.Hint="Separator"/>

                <!--    ページ・タイトル
                        ================
                -->
                <Label Text="{app:Translate TileCrop}"
                       VerticalOptions="Center"
                       HorizontalOptions="Center"
                       FontSize="Large"/>
            </HorizontalStackLayout>

            <!-- 「言語を選ぶ」 -->
            <Picker Grid.Column="1"
                    VerticalOptions="Center"
                    HorizontalOptions="End"
                    ItemsSource="{Binding LocaleIdCollection}"
                    SelectedItem="{Binding CultureInfoAsStr}"
                    SelectedIndexChanged="LocalePicker_SelectedIndexChanged"/>
        </Grid>
    </Shell.TitleView>

    <Grid RowDefinitions="84,*,172">

        <!--    上メニュー
                ==========
        -->
        <Grid Grid.Row="0"
              RowDefinitions="20,48" ColumnDefinitions="64,64,64,64,64,64,64,64,64,64,64,*"
              Padding="8,8,8,8"
              BackgroundColor="SkyBlue">

            <!--    ◆１段目　ラベル列
                    ==================
            -->
            <!-- 「よこ」 -->
            <Label Grid.Row="0" Grid.Column="1"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Width}"/>

            <!-- 「たて」 -->
            <Label Grid.Row="0" Grid.Column="2"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Height}"/>

            <!-- 「ひだり」 -->
            <Label Grid.Row="0" Grid.Column="4"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Left}"/>

            <!-- 「うえ」 -->
            <Label Grid.Row="0" Grid.Column="5"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Top}"/>

            <!-- 「よこ」 -->
            <Label Grid.Row="0" Grid.Column="7"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Width}"/>

            <!-- 「たて」 -->
            <Label Grid.Row="0" Grid.Column="8"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Height}"/>

            <!--    ２段目
                    ======
            -->
            <!-- 「画像」 -->
            <Label Grid.Row="1" Grid.Column="0"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{app:Translate Image}"/>

            <!-- 画像の横幅 -->
            <Label Grid.Row="1" Grid.Column="1"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   FontSize="24"
                   Text="{Binding ImageWidthAsInt}"/>

            <!-- 画像の縦幅 -->
            <Label Grid.Row="1" Grid.Column="2"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   FontSize="24"
                   Text="{Binding ImageHeightAsInt}"/>

            <!-- 「グリッド\n全体」 -->
            <Label Grid.Row="1" Grid.Column="3"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{app:Translate EntireGrid}"/>

            <!-- グリッド左 -->
            <Entry Grid.Row="1" Grid.Column="4"
                   HorizontalTextAlignment="End"
                   Placeholder="0"
                   Text="{Binding GridLeftAsInt}"
                   BackgroundColor="FloralWhite"/>

            <!-- グリッド上 -->
            <Entry Grid.Row="1" Grid.Column="5"
                   HorizontalTextAlignment="End"
                   Placeholder="0"
                   Text="{Binding GridTopAsInt}"
                   BackgroundColor="FloralWhite"/>

            <!-- 「グリッド\n１ます」 -->
            <Label Grid.Row="1" Grid.Column="6"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{app:Translate GridOne}"/>

            <!-- グリッド・タイル横幅 -->
            <Entry Grid.Row="1" Grid.Column="7"
                   HorizontalTextAlignment="End"
                   Placeholder="32"
                   Text="{Binding GridTileWidthAsInt}"
                   BackgroundColor="FloralWhite">
                <Entry.Behaviors>
                    <toolkit:NumericValidationBehavior InvalidStyle="{StaticResource InvalidEntryStyle}"
                                                       ValidStyle="{StaticResource ValidEntryStyle}"
                                                       Flags="ValidateOnValueChanged"
                                                       MinimumValue="1"
                                                       MaximumValue="{Binding TileMaxWidthAsInt}"
                                                       MaximumDecimalPlaces="0" />
                </Entry.Behaviors>
            </Entry>

            <!-- グリッド・タイル縦幅 -->
            <Entry Grid.Row="1" Grid.Column="8"
                   HorizontalTextAlignment="End"
                   Placeholder="32"
                   Text="{Binding GridTileHeightAsInt}"
                   BackgroundColor="FloralWhite">
                <Entry.Behaviors>
                    <toolkit:NumericValidationBehavior InvalidStyle="{StaticResource InvalidEntryStyle}"
                                                       ValidStyle="{StaticResource ValidEntryStyle}"
                                                       Flags="ValidateOnValueChanged"
                                                       MinimumValue="1"
                                                       MaximumValue="{Binding TileMaxHeightAsInt}"
                                                       MaximumDecimalPlaces="0" />
                </Entry.Behaviors>
            </Entry>

            <!-- 「ズーム」 -->
            <Label Grid.Row="1" Grid.Column="9"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{app:Translate Zoom}"/>

            <!-- ズーム -->
            <Entry Grid.Row="1" Grid.Column="10"
                   HorizontalTextAlignment="End"
                   Placeholder="32"
                   Text="{Binding ZoomAsDouble}"
                   BackgroundColor="FloralWhite">
                <Entry.Behaviors>
                    <toolkit:NumericValidationBehavior InvalidStyle="{StaticResource InvalidEntryStyle}"
                                                       ValidStyle="{StaticResource ValidEntryStyle}"
                                                       Flags="ValidateOnValueChanged"
                                                       MinimumValue="{Binding ZoomMinAsDouble}"
                                                       MaximumValue="{Binding ZoomMaxAsDouble}"
                                                       MaximumDecimalPlaces="1" />
                </Entry.Behaviors>
            </Entry>

        </Grid>

        <ScrollView Grid.Row="1">
            <Grid RowDefinitions="*" ColumnDefinitions="*">

                <!--    作業中のタイルセット・キャンバス画像
                        ====================================

                        MAUI には マウス・ダウンと、マウス・アップの捕捉がなく、
                        ペン・ツールのようなことができない
                -->
                <Image IsVisible="False"
                       x:Name="tileImage"
                       Grid.Row="0" Grid.Column="0"
                       HorizontalOptions="Start" VerticalOptions="Start"
                       Margin="4,4,0,0"
                       WidthRequest="{Binding ImageWidthAsInt}" HeightRequest="{Binding ImageHeightAsInt}"                       
                       Source="{Binding WorkingTilesetImageFilePathAsStr}">
                    <Image.GestureRecognizers>
                        <TapGestureRecognizer Tapped="TapGestureRecognizer_Tapped"/>
                        <PointerGestureRecognizer PointerMoved="PointerGestureRecognizer_PointerMoved"/>
                    </Image.GestureRecognizers>
                </Image>
                <!--
                -->

                <!--    タイルセット画像
                        ================
                
                        * スキア・シャープのキャンバスを使う
                -->
                <skia:SKCanvasView IsVisible="True"
                                   x:Name="skiaView1"
                                   Grid.Row="0" Grid.Column="0"
                                   HorizontalOptions="Start" VerticalOptions="Start"
                                   Margin="4,4,0,0"
                                   WidthRequest="{Binding ImageWidthAsInt}" HeightRequest="{Binding ImageHeightAsInt}"                       
                                   IgnorePixelScaling="True"
                                   PaintSurface="skiaView1_PaintSurface">
                    <skia:SKCanvasView.GestureRecognizers>
                        <TapGestureRecognizer Tapped="TapGestureRecognizer_Tapped"/>
                        <PointerGestureRecognizer PointerMoved="PointerGestureRecognizer_PointerMoved"/>
                    </skia:SKCanvasView.GestureRecognizers>
                </skia:SKCanvasView>

                <!--    グリッド
                        ========

                        * タイル・カーソルの線の太さを 4px として、 Margin の左と上は グリッドの線の太さの半分 1 を引いて 3 から始める
                        * その代わり、画像サイズは縦横 2px 増やす
                -->
                <GraphicsView HorizontalOptions="Start" VerticalOptions="Start"
                              Margin="3,3,0,0"
                              WidthRequest="{Binding GridCanvasWidthAsInt}" HeightRequest="{Binding GridCanvasHeightAsInt}"
                              InputTransparent="True">
                    <GraphicsView.Drawable>
                        <modelsDrawing:TilesetGrid BindingContext="{x:Reference thisContentPage}"
                                                   HalfThicknessOfGridLineAsInt="{Binding TileCropPageVM.HalfThicknessOfGridLineAsInt}"
                                                   GridLeftTop="{Binding TileCropPageVM.GridLeftTop}"
                                                   GridTileSize="{Binding TileCropPageVM.GridTileSize}"/>
                    </GraphicsView.Drawable>
                </GraphicsView>

                <!--    カラード・マップ
                        ================
                -->
                <GraphicsView x:Name="coloredMapGraphicsView"
                              HorizontalOptions="Start" VerticalOptions="Start"
                              Margin="4,4,0,0"
                              WidthRequest="{Binding ImageWidthAsInt}" HeightRequest="{Binding ImageHeightAsInt}"
                              InputTransparent="True">
                    <GraphicsView.Drawable>
                        <modelsDrawing:ColoredMap BindingContext="{x:Reference thisContentPage}"
                                                  TilesetSettings="{Binding TileCropPageVM.TilesetSettings}"/>
                    </GraphicsView.Drawable>
                </GraphicsView>

                <!--    タイル状のカーソル
                        ==================
                
                        * カーソルの線の幅が 4px なので、画像サイズは + 8px にする
                -->
                <GraphicsView HorizontalOptions="Start" VerticalOptions="Start"
                              Margin="{Binding TileCursorPointAsMargin}"
                              WidthRequest="{Binding TileCursorCanvasWidthAsInt}" HeightRequest="{Binding TileCursorCanvasHeightAsInt}"
                              InputTransparent="True">
                    <GraphicsView.Drawable>
                        <modelsDrawing:TileCursor BindingContext="{x:Reference thisContentPage}"
                                                  HalfThicknessOfTileCursorLine="{Binding TileCropPageVM.HalfThicknessOfTileCursorLine}"
                                                  SelectedTileSize="{Binding TileCropPageVM.SelectedTileSize}"
                                                  SelectingOnPointingDevice="{Binding TileCropPageVM.SelectingOnPointingDevice}"/>
                    </GraphicsView.Drawable>
                </GraphicsView>

            </Grid>
        </ScrollView>

        <!--    下メニュー
                ==========
        -->
        <Grid Grid.Row="2"
              RowDefinitions="20,48,20,48,20" ColumnDefinitions="128,64,64,64,64,64,*"
              Padding="8,8,8,8"
              BackgroundColor="SkyBlue">

            <!--    ◆ボタン縦並び
                    ==============
            -->
            <Grid Grid.Row="0" Grid.Column="0" Grid.RowSpan="5">
                <VerticalStackLayout>

                    <!-- 追加／上書ボタン -->
                    <Button IsEnabled="{Binding AddsButtonIsEnabled}"
                            Text="{Binding AddsButtonText}"
                            ToolTipProperties.Text="{Binding AddsButtonHint}"
                            Clicked="AddsButton_Clicked">
                        <Button.GestureRecognizers>
                            <PointerGestureRecognizer PointerEntered="Button_PointerGestureRecognizer_PointerEntered"
                                                  PointerExited="Button_PointerGestureRecognizer_PointerExited"/>
                        </Button.GestureRecognizers>
                    </Button>

                    <!-- ［削除］ボタン -->
                    <Button Margin="0,40,0,0"
                            IsEnabled="{Binding DeletesButtonIsEnabled}"
                            Text="{app:Translate Delete}"
                            Clicked="DeletesButton_Clicked">
                        <Button.GestureRecognizers>
                            <PointerGestureRecognizer PointerEntered="Button_PointerGestureRecognizer_PointerEntered"
                                                  PointerExited="Button_PointerGestureRecognizer_PointerExited"/>
                        </Button.GestureRecognizers>
                    </Button>

                </VerticalStackLayout>
            </Grid>

            <!--    ◆０段目 読み仮名部
                    ===================
            -->
            <!-- 「ひだり」 -->
            <Label Grid.Row="0" Grid.Column="2"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Left}"/>

            <!-- 「うえ」 -->
            <Label Grid.Row="0" Grid.Column="3"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Top}"/>

            <!-- 「よこ」 -->
            <Label Grid.Row="0" Grid.Column="4"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Width}"/>

            <!-- 「たて」 -->
            <Label Grid.Row="0" Grid.Column="5"
                   HorizontalTextAlignment="End"
                   Text="{app:Translate Height}"/>

            <!--    ◆２段目 入力部
                    ===============
            -->
            <!-- カーソル -->
            <Label Grid.Row="1" Grid.Column="1"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{app:Translate Cursor}"/>

            <!-- 選択タイルＸ -->
            <Label Grid.Row="1" Grid.Column="2"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{Binding SelectedTileLeftAsInt}"
                   FontSize="24"/>

            <!-- 選択タイルＹ -->
            <Label Grid.Row="1" Grid.Column="3"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{Binding SelectedTileTopAsInt}"
                   FontSize="24"/>

            <!-- 選択タイル横幅 -->
            <Label Grid.Row="1" Grid.Column="4"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{Binding SelectedTileWidthAsInt}"
                   FontSize="24"/>

            <!-- 選択タイル縦幅 -->
            <Label Grid.Row="1" Grid.Column="5"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{Binding SelectedTileHeightAsInt}"
                   FontSize="24"/>

            <!--    ◆３段目 読み仮名部
                    ===================
            -->
            <!-- 「管理コード」 -->
            <Label Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2"
                   HorizontalTextAlignment="End"
                   Padding="0,0,4,0"
                   Text="{app:Translate ControlCode}"/>

            <!-- 「タイル名」 -->
            <Label Grid.Row="2" Grid.Column="3" Grid.ColumnSpan="4"
                   Padding="20,0,0,0"
                   Text="{app:Translate TileName}"/>

            <!--    ４段目 入力部
                    =============
            -->
            <!-- 管理コード BASE64形式 -->
            <Entry Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="2"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Center"
                   Text="{Binding SelectedTileIdAsBASE64, Mode=OneWay}"
                   IsReadOnly="True"/>

            <!-- タイル名 -->
            <Entry Grid.Row="3" Grid.Column="3" Grid.ColumnSpan="4"
                   Placeholder="草原"
                   Text="{Binding SelectedTileCommentAsStr}"
                   BackgroundColor="FloralWhite"/>

            <!--    ５段目 ヒント部
                    ===============
            -->
            <!-- 「コードのおぼえかた」 -->
            <Label Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="2"
                   HorizontalTextAlignment="End"
                   VerticalTextAlignment="Start"
                   Padding="0,0,4,0"
                   Text="{app:Translate HowToRememberControlCode}"/> 

            <!-- コードのおぼえかた -->
            <Label Grid.Row="4" Grid.Column="3" Grid.ColumnSpan="4"
                   HorizontalTextAlignment="Start"
                   VerticalTextAlignment="Start"
                   Padding="0,0,4,0"
                   Text="{Binding SelectedTileIdAsPhoneticCode}"/>
        </Grid>
    </Grid>
</ContentPage>